<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Document</title>
</head>

<body>
    <div id="secretForm">
        <h3>Day la khu vuc bao mat! üîí</h3>
        <button id="secretBtn" onclick="getSecret()">XEM BI MAT</button>
        <button onclick="logOut()">Log out!</button>
        <div>
            <p id="secretText" style="color: blue; " class="hidden"></p>
        </div>
    </div>
    <script>
        let accessToken = window.opener?.accessToken || window.accessToken || null;

        async function getSecret() {
            const res = await fetch('/api/secret', {
                credentials: 'include', // ƒë·ªÉ g·ª≠i refresh token cookie
                headers: { Authorization: `Bearer ${accessToken}` }
            });

            if (res.ok) {
                const data = await res.json();
                document.getElementById('secretText').classList.remove('hidden');
                document.getElementById('secretText').textContent = data.message;
            }
            else if (res.status === 403) {
                // H·∫øt h·∫°n access token, g·ªçi refresh
                const refresh = await fetch('/api/refresh', {
                    method: 'POST',
                    credentials: 'include'
                });

                if (refresh.ok) {
                    const data = await refresh.json();
                    accessToken = data.token; // c·∫•p l·∫°i
                    getSecret(); // th·ª≠ l·∫°i
                } else {
                    alert('Het phien dang nhap, vui long dang nhap lai.');
                    logOut();
                }
            }
            else {
                alert('Loi khong xac dinh.');
            }
        }

        async function logOut() {
            await fetch('/api/logout', { method: 'POST', credentials: 'include' });
            accessToken = null;
            window.location.href = 'index.html';
        }

        // T·ª± ƒë·ªông c·∫•p l·∫°i access token khi m·ªü trang
        async function checkrfToken() {
            const res = await fetch('/api/refresh', {
                method: 'POST',
                credentials: 'include'
            });
            if (res.ok) {
                const data = await res.json();
                accessToken = data.token;
            } else {
                alert('Da het phien dang nhap, vui long dang nhap lai...');
                window.location.href = 'index.html';
            }
        }

        checkrfToken();

    </script>
</body>

</html>